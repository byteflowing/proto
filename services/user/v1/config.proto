syntax = "proto3";

package services.user.v1;

import "enums/v1/user.proto";
import "validation/v1/predefined_rules.proto";
import "buf/validate/validate.proto";
import "google/protobuf/duration.proto";
import "limiter/v1/limiter.proto";

message UserAuthLimiterConfig {
  string prefix = 1;
  string err_prefix = 2;
  limiter.v1.LimitRule sign_in_rule = 3;
  limiter.v1.LimitRule refresh_rule= 4;
  repeated limiter.v1.LimitRule sign_in_err_rules = 5;
}

message SessionBlockListConfig {
  string prefix = 1;
}

message UserJwtConfig {
  // token签发者
  string issuer = 1 [(buf.validate.field).string.(validation.v1.required_20) = true];
  // 安全密钥
  string secret_key = 2 [(buf.validate.field).string.(validation.v1.required_50) = true];
  // 签名方法
  string sign_method = 3;
  int32 max_active_sessions = 4;
  // 访问token有效时间
  google.protobuf.Duration access_ttl = 5 [(buf.validate.field).duration.gte = {seconds: 60}];
  // 刷新token有效时间
  google.protobuf.Duration refresh_ttl = 6 [(buf.validate.field).duration.gte = {seconds: 600}];
}

message UserCacheConfig {}

message TokenVerifyConfig {
  string prefix = 1;
  google.protobuf.Duration keeping = 2;
}

message UserConfig {
  string listen_addr = 1;
  int32 listen_port = 2;
  int32 password_hasher_cost = 3;
  repeated enums.v1.AuthType enable_auth = 4;
  UserAuthLimiterConfig auth_limiter = 5;
  UserJwtConfig jwt = 6;
  TokenVerifyConfig two_step_verifier = 7;
  UserCacheConfig cache = 8;
  SessionBlockListConfig session_block_list = 9;
}